 <script>
 
  const SUPABASE_URL = 'https://utecoensjmonkiyzswil.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZWNvZW5zam1vbmtpeXpzd2lsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2OTg1NDgsImV4cCI6MjA2NDI3NDU0OH0.iv7HM9tdcLAXn9ZHGiPSrYQXsiIGim46LHZMHa1w0sU';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // --- Activity Tracker Class ---
  class ActivityTracker {
    constructor() {
      this.initializeTracking();
    }

    initializeTracking() {
      const defaultActivity = {
        tasksCompleted: 0,
        totalSessions: 0,
        loginStreak: 0,
        lastLoginDate: null,
        activeDays: [],
        sessionStartTime: null,
        dailyTasks: {},
        loginHistory: []
      };

      let userActivity = JSON.parse(localStorage.getItem('userActivity') || 'null');
      if (!userActivity) {
        userActivity = defaultActivity;
        localStorage.setItem('userActivity', JSON.stringify(userActivity));
      }

      this.trackSession();
    }

    trackSession() {
      const userActivity = this.getUserActivity();
      const today = new Date().toDateString();
      userActivity.totalSessions++;
      userActivity.sessionStartTime = new Date().toISOString();
      this.updateLoginStreak(userActivity, today);

      if (!userActivity.activeDays.includes(today)) userActivity.activeDays.push(today);
      if (!userActivity.loginHistory.includes(today)) userActivity.loginHistory.push(today);

      this.saveUserActivity(userActivity);
    }

    updateLoginStreak(userActivity, today) {
      const todayDate = new Date(today);
      const lastLogin = userActivity.lastLoginDate ? new Date(userActivity.lastLoginDate) : null;

      if (!lastLogin) userActivity.loginStreak = 1;
      else {
        const daysDiff = Math.floor((todayDate - lastLogin) / (1000 * 60 * 60 * 24));
        if (daysDiff === 1) userActivity.loginStreak++;
        else if (daysDiff !== 0) userActivity.loginStreak = 1;
      }

      userActivity.lastLoginDate = today;
    }

    completeTask() {
      const userActivity = this.getUserActivity();
      const today = new Date().toDateString();

      userActivity.tasksCompleted++;
      if (!userActivity.dailyTasks[today]) userActivity.dailyTasks[today] = 0;
      userActivity.dailyTasks[today]++;

      if (!userActivity.activeDays.includes(today)) userActivity.activeDays.push(today);

      this.saveUserActivity(userActivity);
      this.updateStatsDisplay();
    }

    getUserActivity() {
      return JSON.parse(localStorage.getItem('userActivity') || '{}');
    }

    saveUserActivity(activity) {
      localStorage.setItem('userActivity', JSON.stringify(activity));
    }

    getStats() {
      const userActivity = this.getUserActivity();
      return {
        tasksCompleted: userActivity.tasksCompleted || 0,
        daysActive: userActivity.activeDays ? userActivity.activeDays.length : 0,
        loginStreak: userActivity.loginStreak || 0,
        totalSessions: userActivity.totalSessions || 0
      };
    }

    updateStatsDisplay() {
      const stats = this.getStats();
      document.getElementById('tasksCompleted').textContent = stats.tasksCompleted;
      document.getElementById('daysActive').textContent = stats.daysActive;
      document.getElementById('loginStreak').textContent = stats.loginStreak;
      document.getElementById('totalSessions').textContent = stats.totalSessions;
    }

    resetStats() {
      localStorage.removeItem('userActivity');
      this.initializeTracking();
      this.updateStatsDisplay();
    }
  }

  // --- Initialize Tracker ---
  const activityTracker = new ActivityTracker();

  // --- Theme ---
  function toggleTheme() {
    const body = document.body;
    const themeToggle = document.querySelector('.theme-toggle');
    body.classList.toggle('light');
    body.classList.toggle('dark');
    themeToggle.textContent = body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
  }

  window.addEventListener('load', async function () {
  const savedTheme = localStorage.getItem('theme') || 'light';
  const body = document.body;
  const themeToggle = document.querySelector('.theme-toggle');
  body.classList.remove('light', 'dark');
  body.classList.add(savedTheme);
  themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

  // Force reload if ?refresh=1 is present
  if (window.location.search.includes('refresh=1')) {
    await loadUserProfile();
    // Optionally, remove the query param so it doesn't reload every time
    window.history.replaceState({}, document.title, window.location.pathname);
  } else {
    await loadUserProfile();
  }
});

  function goBack() {
    window.history.back();
  }

  function editProfile() {
    window.location.href = 'aset.html';
  }

  // --- Load Profile from Supabase Auth ---
  async function loadUserProfile() {
    try {
      const {
          data: { session },
          error: sessionError
      } = await supabase.auth.getSession();

      if (sessionError || !session) {
          console.error("No session found:", sessionError);
          return;
      }

      const userId = session.user.id;

      // Fetch profile data from Supabase table (e.g., "profiles")
      const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();

      if (error) {
          console.error("Failed to load profile", error);
          return;
      }

      // Display data
      document.getElementById('usernameDisplay').textContent = profile.username || 'No username';
      document.getElementById('userEmailDisplay').textContent = session.user.email;

      const createdDate = new Date(session.user.created_at);
      document.getElementById('accountCreatedDate').textContent = createdDate.toDateString();
      document.getElementById('memberSinceDate').textContent = calculateDaysSince(createdDate);

      // Optional: profile picture
      if (profile.profile_picture_url) {
          document.getElementById('profilePictureDisplay').innerHTML = 
              `<img src="${profile.profile_picture_url}" alt="Profile Picture">`;
      }

      loadUserStats();
    } catch (error) {
      console.error('Supabase error:', error);
      loadUserProfileFromLocal();
    }
  }
  

  // --- Fallback Profile Load ---
  function loadUserProfileFromLocal() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    let currentUser = JSON.parse(localStorage.getItem('userSession') || 'null') || users.at(-1);

    if (!currentUser) {
      currentUser = {
        username: 'Guest User',
        email: 'guest@prodactivities.com',
        accountCreated: new Date().toISOString()
      };
    }

    document.getElementById('usernameDisplay').textContent = currentUser.username;
    document.getElementById('userEmailDisplay').textContent = currentUser.email;

    const createdDate = new Date(currentUser.accountCreated);
    document.getElementById('accountCreatedDate').textContent = createdDate.toLocaleDateString();
    document.getElementById('memberSinceDate').textContent = calculateDaysSince(createdDate);

    const savedProfilePic = localStorage.getItem('profilePicture');
    if (savedProfilePic) {
      document.getElementById('profilePictureDisplay').innerHTML = `<img src="${savedProfilePic}" alt="Profile Picture">`;
    }

    loadUserStats();
  }

  function calculateDaysSince(createdDate) {
    const now = new Date();
    const diffTime = Math.abs(now - createdDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays === 1) return '1 day';
    if (diffDays < 30) return `${diffDays} days`;
    if (diffDays < 365) return `${Math.floor(diffDays / 30)} months`;
    return `${Math.floor(diffDays / 365)} years`;
  }

  function loadUserStats() {
    const stats = activityTracker.getStats();
    document.getElementById('tasksCompleted').textContent = stats.tasksCompleted;
    document.getElementById('daysActive').textContent = stats.daysActive;
    document.getElementById('loginStreak').textContent = stats.loginStreak;
    document.getElementById('totalSessions').textContent = stats.totalSessions;
    animateStats();
  }

  function animateStats() {
    const statElements = document.querySelectorAll('.stat-number');
    statElements.forEach(element => {
      const finalValue = parseInt(element.textContent);
      let currentValue = 0;
      const increment = Math.max(1, Math.ceil(finalValue / 30));
      element.textContent = '0';
      const timer = setInterval(() => {
        currentValue += increment;
        if (currentValue >= finalValue) {
          element.textContent = finalValue;
          clearInterval(timer);
        } else {
          element.textContent = currentValue;
        }
      }, 50);
    });
  }

  function simulateTaskCompletion() {
    activityTracker.completeTask();
    console.log('Task completed!');
  }

  function simulateLogin() {
    activityTracker.trackSession();
    activityTracker.updateStatsDisplay();
    console.log('New session tracked!');
  }

  function resetStats() {
    if (confirm('Are you sure you want to reset all activity stats?')) {
      activityTracker.resetStats();
      console.log('Stats reset!');
    }
  }

  window.ProdActivitiesTracker = {
    completeTask: () => activityTracker.completeTask(),
    trackSession: () => activityTracker.trackSession(),
    getStats: () => activityTracker.getStats()
  };

  window.addEventListener('storage', function (e) {
    if (['profilePicture', 'currentUser', 'userActivity'].includes(e.key)) {
      loadUserProfile();
    }
  });

  document.addEventListener('touchstart', function () {}, true);
</script>
</body>
</html>
